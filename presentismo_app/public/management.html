<!DOCTYPE html>
<html>
<head>
    <title>Attendance Management</title>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
    <script>
        $(document).ready(() => {
            // Function to retrieve attendance records based on filter criteria
            const getAttendance = () => {
                const subject = $('#subjectFilter').val();
                const date = $('#dateFilter').val();
                const student = $('#studentFilter').val();

                $.get(`/attendance/check?subject=${subject}&date=${date}&student=${student}`, (data) => {
                    $('#attendanceTable tbody').empty();
                    data.forEach((record) => {
                        const row = `<tr><td>${record.studentName}</td><td>${record.subject}</td><td>${record.date}</td></tr>`;
                        $('#attendanceTable tbody').append(row);
                    });
                });
            };

            // Function to export table data to CSV
            const exportToCSV = () => {
                const rows = [];
                const headers = [];

                // Extract header names
                $('#attendanceTable thead th').each((index, element) => {
                    headers.push($(element).text());
                });

                // Extract table data rows
                $('#attendanceTable tbody tr').each((index, element) => {
                    const rowData = [];
                    $(element).find('td').each((index, element) => {
                        rowData.push($(element).text());
                    });
                    rows.push(rowData);
                });

                // Create CSV content
                let csvContent = `${headers.join(',')}\n`;
                rows.forEach((row) => {
                    csvContent += `${row.join(',')}\n`;
                });

                // Download the CSV file
                const filename = 'attendance.csv';
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                if (navigator.msSaveBlob) {
                    navigator.msSaveBlob(blob, filename);
                } else {
                    const link = document.createElement('a');
                    if (link.download !== undefined) {
                        const url = URL.createObjectURL(blob);
                        link.setAttribute('href', url);
                        link.setAttribute('download', filename);
                        link.style.visibility = 'hidden';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    }
                }
            };

            // Event handler for filter button click
            $('#filterBtn').click(() => {
                getAttendance();
            });

            // Event handler for export button click
            $('#exportBtn').click(() => {
                exportToCSV();
            });
        });
    </script>
</head>
<body>
    <h1>Attendance Management</h1>
    <div>
        <label for="subjectFilter">Subject:</label>
        <input type="text" id="subjectFilter"><br><br>

        <label for="dateFilter">Date:</label>
        <input type="date" id="dateFilter"><br><br>

        <label for="studentFilter">Student:</label>
        <input type="text" id="studentFilter"><br><br>

        <button id="filterBtn">Filter</button>
        <button id="exportBtn">Export to CSV</button>
    </div>

    <table id="attendanceTable">
        <thead>
            <tr>
                <th>Student Name</th>
                <th>Subject</th>
                <th>Date</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe" crossorigin="anonymous"></script>
</body>
</html>